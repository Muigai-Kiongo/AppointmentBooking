{# This is a fragment (no <html> wrapper). It will be included inside your page. #}
    <div class="report-fragment">
        <!-- Chart.js CDN: if your base already includes Chart.js you can remove this line -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
        <h3>Weekly Summary</h3>
    
        <div style="max-width:1000px;margin:0 auto;">
            <canvas id="timelineChart_weekly" style="width:100%;height:220px"></canvas>
        </div>
    
        <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:16px;">
            <div style="flex:1;min-width:260px">
                <h4>By Appointment Type</h4>
                <canvas id="typeChart_weekly" style="height:220px"></canvas>
            </div>
            <div style="flex:1;min-width:260px">
                <h4>By Status</h4>
                <canvas id="statusChart_weekly" style="height:220px"></canvas>
            </div>
        </div>
    
        <h4 style="margin-top:18px">Appointments (list)</h4>
        <div style="overflow:auto; max-height:360px; border-top:1px solid #eaeaea; padding-top:8px;">
            <table style="width:100%;border-collapse:collapse">
                <thead>
                    <tr>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Patient</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Doctor</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Type</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Date</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Time</th>
                        <th style="text-align:left;padding:6px;border-bottom:1px solid #eee">Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for appt in appointments %}
                    <tr>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.user.username }}</td>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.doctor.user.username }}</td>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.appointment_type.name }}</td>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.appointment_date }}</td>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.appointment_time }}</td>
                        <td style="padding:6px;border-bottom:1px solid #f6f6f6">{{ appt.status }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6" style="padding:8px">No appointments in this period.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
    (function(){
        const payload = {{ chart_payload_json|safe }};
    
        // Timeline (line)
        const ctxT = document.getElementById('timelineChart_weekly').getContext('2d');
        new Chart(ctxT, {
            type: 'line',
            data: {
                labels: payload.timeline.labels,
                datasets: [{
                    label: 'Appointments',
                    data: payload.timeline.data,
                    borderColor: 'rgba(54,162,235,1)',
                    backgroundColor: 'rgba(54,162,235,0.15)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    
        // Types (bar)
        const ctxType = document.getElementById('typeChart_weekly').getContext('2d');
        new Chart(ctxType, {
            type: 'bar',
            data: {
                labels: payload.type_counts.map(t => t.type),
                datasets: [{
                    label: 'Count',
                    data: payload.type_counts.map(t => t.count),
                    backgroundColor: payload.type_counts.map((_, i) => `hsl(${(i*60)%360} 65% 55%)`)
                }]
            },
            options: { responsive: true }
        });
    
        // Status (doughnut)
        const ctxStatus = document.getElementById('statusChart_weekly').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: payload.status_counts.map(s => s.status),
                datasets: [{
                    data: payload.status_counts.map(s => s.count),
                    backgroundColor: ['#4CAF50','#2196F3','#F44336']
                }]
            },
            options: { responsive: true }
        });
    })();
    </script>